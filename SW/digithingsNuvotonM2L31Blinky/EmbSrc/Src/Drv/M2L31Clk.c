#include "..\Target\Target.h"
#include "..\M2L31_Gen\M2L31_CLK_Def.h"

#define RCC_HSI_OSC_8000000 8000000

#define RCC_PLLSRC_NO_CLOCK_00 0
#define RCC_PLLSRC_NO_CLOCK_01 1
#define RCC_PLLSRC_HSI16_02 2
#define RCC_PLLSRC_HSE_03 3


#define RCC_CFGR_SW_HSI16 1
#define RCC_CFGR_SW_HSE 2
#define RCC_CFGR_SW_PLL 3

void M2L31ClkPllInit(void) {
#if 0
	volatile sSTM32F302_RCC* pSTM32F302_RCC = (sSTM32F302_RCC*)F302_RCC_ADR;
	volatile uSTM32F302_RCC_CR STM32F302_RCC_CR;
	volatile uSTM32F302_RCC_CFGR STM32F302_RCC_CFGR;

	while(1 != pSTM32F302_RCC->STM32F302_RCC_CR.Bit.HSIRDY){
		//asm("NOP");
	}

	STM32F302_RCC_CFGR.All = 0;
	STM32F302_RCC_CFGR.Bit.PLLMUL = 0xA; /* 4 * 12 = 48 MHz */
	STM32F302_RCC_CFGR.Bit.PLLSRC = 0; /* HSI div 2 = 4MHz */
	pSTM32F302_RCC->STM32F302_RCC_CFGR.All = STM32F302_RCC_CFGR.All;

	STM32F302_RCC_CR.All = pSTM32F302_RCC->STM32F302_RCC_CR.All;
	STM32F302_RCC_CR.Bit.PLLON = 1;
	pSTM32F302_RCC->STM32F302_RCC_CR.All = STM32F302_RCC_CR.All;

	while(1 != pSTM32F302_RCC->STM32F302_RCC_CR.Bit.PLLRDY){
		ASM("NOP");
	}

	STM32F302_RCC_CFGR.All = pSTM32F302_RCC->STM32F302_RCC_CFGR.All;
	STM32F302_RCC_CFGR.Bit.SW = 2;
	STM32F302_RCC_CFGR.Bit.MCO = 4;
	pSTM32F302_RCC->STM32F302_RCC_CFGR.All = STM32F302_RCC_CFGR.All;
#endif
}


void M2L31ClkInit(void)
{
	// M2L31ClkPllInit(); TODO

	volatile sM2L31_CLK* pM2L31_CLK = (sM2L31_CLK*)M2L31_CLK_ADR;
	uM2L31_CLK_CLK_AHBCLK0 M2L31_CLK_CLK_AHBCLK0;
	uM2L31_CLK_CLK_APBCLK0 M2L31_CLK_CLK_APBCLK0;



	M2L31_CLK_CLK_AHBCLK0.All = 0;			// Reset value: 0x0000 0000
	M2L31_CLK_CLK_AHBCLK0.Bit.GPCCKEN = 1;
	M2L31_CLK_CLK_AHBCLK0.Bit.GPBCKEN = 1;
	M2L31_CLK_CLK_AHBCLK0.Bit.GPDCKEN = 1;
	M2L31_CLK_CLK_AHBCLK0.Bit.GPACKEN = 1;
	pM2L31_CLK->M2L31_CLK_CLK_AHBCLK0.All = M2L31_CLK_CLK_AHBCLK0.All;

	M2L31_CLK_CLK_APBCLK0.All = 0;			// Reset value: 0x0000 0000
	M2L31_CLK_CLK_APBCLK0.Bit.EADC0CKEN = 1;
	pM2L31_CLK->M2L31_CLK_CLK_APBCLK0.All = M2L31_CLK_CLK_APBCLK0.All;



}
